<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Cost Distribution Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Tailwind gray-100 */
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px 12px;
            font: 12px 'Inter', sans-serif;
            background: #2d3748; /* Tailwind gray-800 */
            color: white;
            border: 0;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        #drilldown-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s ease-in-out, padding 0.7s ease-in-out, margin 0.7s ease-in-out;
            width: 100%;
        }
        #drilldown-container.visible {
            max-height: 600px; /* Adjust as needed */
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        /* Sunburst Styles */
        .sunburst-arc path { cursor: pointer; stroke: #fff; stroke-width: 1.5px; }
        .sunburst-arc path:hover { opacity: 0.8; }
        .sunburst-text { font-size: 10px; fill: #fff; text-anchor: middle; pointer-events: none; dominant-baseline: middle; }
        
        /* Treemap Styles */
        .treemap-tile { stroke: #fff; stroke-width: 2px; }
        .treemap-label { fill: #fff; font-size: 12px; font-weight: 500; pointer-events: none; }

        /* Bar Chart Styles */
        .bar { cursor: pointer; transition: fill 0.2s; }
        .bar:hover { fill: #3b82f6; }

        /* Line Chart Styles */
        .line { fill: none; stroke: #2563eb; stroke-width: 2px; }
        .axis-label { font-size: 12px; fill: #374151; }
        .grid line { stroke: #e5e7eb; stroke-opacity: 0.7; shape-rendering: crispEdges; }

        /* AI Panel Spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="min-h-screen p-4 lg:p-8">
        <div class="w-full max-w-screen-2xl mx-auto bg-white rounded-2xl shadow-lg p-6 lg:p-8">
            <!-- Dashboard Header -->
            <header class="flex flex-col sm:flex-row items-center justify-between mb-6 pb-4 border-b border-gray-200">
                <!-- Left Side: Title and Nav Menus -->
                <div class="flex items-center gap-8 w-full sm:w-auto mb-4 sm:mb-0">
                    <h1 class="text-2xl font-bold text-gray-900 whitespace-nowrap">My Dashboard</h1>
                    <nav class="hidden md:flex items-center gap-6 text-sm font-medium text-gray-500">
                        <a href="#" class="text-blue-600 border-b-2 border-blue-600 pb-1">Cost Analysis</a>
                        <a href="#" class="hover:text-blue-600 transition-colors">Reports</a>
                        <a href="#" class="hover:text-blue-600 transition-colors">Budgets</a>
                        <a href="#" class="hover:text-blue-600 transition-colors">Settings</a>
                    </nav>
                </div>
                <!-- Right Side: Search and User Profile -->
                <div class="flex items-center gap-4 w-full sm:w-auto">
                    <div class="relative w-full max-w-xs">
                        <input type="search" placeholder="Search..." class="bg-gray-100 border-none rounded-lg pl-10 pr-4 py-2 text-sm w-full focus:ring-2 focus:ring-blue-500">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <button class="p-2 rounded-full hover:bg-gray-100 text-gray-500">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    </button>
                    <img src="https://placehold.co/40x40/E2E8F0/475569?text=JD" alt="User" class="w-10 h-10 rounded-full cursor-pointer">
                </div>
            </header>
            
            <p class="text-sm lg:text-base text-gray-500 mb-6">Interactive visualization of cost allocation across the organization over time.</p>

            <!-- Main View: Controls + Main Chart -->
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Controls and Info Panel -->
                <div class="w-full lg:w-1/4 lg:pr-8 border-b lg:border-b-0 lg:border-r border-gray-200 pb-6 lg:pb-0">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Controls & Details</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="view-toggle" class="block text-sm font-medium text-gray-700 mb-2">Primary Hierarchy</label>
                            <select id="view-toggle" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                <option value="org" selected>By Organization</option>
                                <option value="cost">By Cost Category</option>
                            </select>
                        </div>
                        <div>
                            <label for="chart-toggle" class="block text-sm font-medium text-gray-700 mb-2">Chart Type</label>
                            <select id="chart-toggle" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                <option value="sunburst" selected>Sunburst</option>
                                <option value="treemap">Treemap</option>
                                <option value="bar">Bar Chart</option>
                            </select>
                        </div>
                    </div>
                    <div id="info-panel" class="bg-gray-50 rounded-lg p-4 space-y-2 text-sm mt-6">
                         <h3 class="font-bold text-gray-900">Hover or Click a Segment</h3>
                         <p class="text-gray-600">Details will appear here.</p>
                    </div>
                    <h3 class="text-md font-semibold text-gray-800 mt-6 mb-2">Legend</h3>
                    <div id="legend" class="space-y-2 text-sm"></div>

                    <!-- AI Insights Section -->
                    <div class="mt-6">
                        <button id="ai-insights-button" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                            âœ¨ Get AI Insights
                        </button>
                        <div id="ai-insights-panel" class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm mt-4 space-y-2" style="display: none;">
                            <!-- Content will be injected by JS -->
                        </div>
                    </div>
                </div>

                <!-- Main Visualization Area -->
                <div class="w-full lg:w-3/4 flex flex-col items-center">
                    <div class="w-full text-center text-gray-600 text-base mb-2 h-5 font-semibold">Overall Distribution</div>
                    <div id="main-chart-container" class="w-full h-96 lg:h-[500px] relative"></div>
                </div>
            </div>

            <!-- Drilldown View Container -->
            <div id="drilldown-container">
                 <div id="drilldown-header" class="w-full text-center text-sm mb-2 h-5 flex items-center justify-center gap-4">
                    <button id="back-button" class="text-blue-600 hover:underline">&larr; Close Drilldown</button>
                    <div id="breadcrumb" class="text-gray-800 font-semibold"></div>
                </div>
                <div id="drilldown-chart-container" class="w-full h-96 lg:h-[500px] relative"></div>
            </div>

             <!-- Footer Note -->
            <div class="text-center text-xs text-gray-400 mt-8 pt-4 border-t border-gray-200">
                Click a segment in the main chart to see a detailed drill-down view.
            </div>
        </div>
    </div>

    <script type="module">
        // --- DATA SETUP WITH TIME DIMENSION (values array represents 4 quarters) ---
        const costData = { name: "Total Costs", children: [ { name: "Salaries", children: [{ name: "Full-Time", values: [110000, 115000, 112000, 113000] },{ name: "Part-Time", values: [20000, 18000, 22000, 20000] },{ name: "Contractors", values: [30000, 35000, 25000, 30000] },]}, { name: "Software & Services", children: [{ name: "Cloud Hosting (AWS)", values: [18000, 19000, 19500, 18500] },{ name: "CRM Software", values: [6000, 6200, 6300, 6500] },{ name: "Productivity Tools", children: [{ name: "Design Suite", values: [3500, 3600, 3700, 3800] },{ name: "Office Suite", values: [2500, 2500, 2500, 2500] },] },]}, { name: "Marketing & Sales", children: [{ name: "Digital Ads", values: [15000, 18000, 20000, 7000] },{ name: "Conferences", values: [0, 20000, 0, 20000] },{ name: "SEO Tools", values: [1200, 1200, 1300, 1300] },]}, { name: "Operations", children: [{ name: "Office Rent", values: [22500, 22500, 22500, 22500] },{ name: "Utilities", values: [3000, 4000, 4500, 3500] },{ name: "Supplies", values: [1500, 2000, 1800, 1700] },]}, ] };
        const orgData = { name: "Global Corp.", children: [ { name: "Engineering", children: [{ name: "Salaries", values: [80000, 85000, 82000, 83000] },{ name: "Cloud Hosting (AWS)", values: [15000, 15000, 16000, 14000] },{ name: "Productivity Tools", values: [3000, 3000, 3000, 3000] },]}, { name: "Sales & Marketing", children: [{ name: "Salaries", values: [45000, 48000, 46000, 41000] },{ name: "CRM Software", values: [6000, 6200, 6300, 6500] },{ name: "Digital Ads", values: [15000, 18000, 20000, 7000] },{ name: "Conferences", values: [0, 20000, 0, 20000] },]}, { name: "Operations & Admin", children: [{ name: "Salaries", values: [25000, 25000, 25000, 25000] },{ name: "Office Rent", values: [22500, 22500, 22500, 22500] },{ name: "Utilities", values: [3000, 4000, 4500, 3500] },{ name: "Supplies", values: [1500, 2000, 1800, 1700] },]} ] };

        // --- GLOBAL STATE ---
        let currentData = orgData;
        let currentHierarchyRoot;
        let currentChartType = 'sunburst';

        const mainContainer = d3.select("#main-chart-container");
        const drilldownContainer = d3.select("#drilldown-container");
        const drilldownChartContainer = d3.select("#drilldown-chart-container");
        const infoPanel = d3.select("#info-panel");
        const breadcrumbContainer = d3.select("#breadcrumb");
        const backButton = d3.select("#back-button");
        const legendContainer = d3.select("#legend");
        const aiInsightsPanel = d3.select("#ai-insights-panel");
        const tooltip = d3.select("body").append("div").attr("class", "tooltip");
        const color = d3.scaleOrdinal(d3.schemeTableau10);

        function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }

        // --- RENDER CONTROLLERS ---
        function renderMainChart() {
            mainContainer.selectAll("*").remove();
            drilldownContainer.classed("visible", false);
            aiInsightsPanel.style("display", "none").html("");
            
            const hierarchy = d3.hierarchy(currentData).sum(d => d.values ? d3.sum(d.values) : 0).sort((a, b) => b.value - a.value);
            currentHierarchyRoot = hierarchy;
            
            const chartRenderer = getChartRenderer(currentChartType);
            chartRenderer(hierarchy, mainContainer, true);
            renderLegend(hierarchy);
        }

        function renderDrilldownChart(node) {
            drilldownChartContainer.selectAll("*").remove();
            updateBreadcrumb(node);
            if (!node.children) {
                renderLineChart(node, drilldownChartContainer);
            } else {
                const chartRenderer = getChartRenderer(currentChartType);
                chartRenderer(node, drilldownChartContainer, false);
            }
            drilldownContainer.classed("visible", true);
            setTimeout(() => {
                document.getElementById('drilldown-container').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function getChartRenderer(chartType) {
            switch(chartType) {
                case 'treemap': return renderTreemap;
                case 'bar': return renderBarChart;
                case 'sunburst':
                default: return renderSunburst;
            }
        }
        
        // --- CHART IMPLEMENTATIONS ---
        function renderSunburst(data, targetContainer, isMainChart) {
            const { width, height } = targetContainer.node().getBoundingClientRect();
            const radius = Math.min(width, height) / (isMainChart ? 6 : 7);
            const root = d3.partition().size([2 * Math.PI, data.height + 1])(data);
            const arc = d3.arc().startAngle(d => d.x0).endAngle(d => d.x1).padAngle(0.005).padRadius(radius * 1.5).innerRadius(d => d.y0 * radius).outerRadius(d => Math.max(d.y0 * radius, d.y1 * radius - 1));
            const svg = targetContainer.append("svg").attr("viewBox", [-width / 2, -height / 2, width, height]);
            const g = svg.append("g").attr("class", "sunburst-arc");

            g.selectAll("path").data(root.descendants().slice(1)).join("path")
                .attr("fill", d => { while (d.depth > 1) d = d.parent; return color(d.data.name); })
                .attr("fill-opacity", d => (d.children ? 0.8 : 0.6)).attr("d", arc).style("cursor", "pointer")
                .on("click", isMainChart ? (e, p) => renderDrilldownChart(p) : null)
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`<strong>${d.data.name}</strong><br/>Total: $${d.value.toLocaleString()}`).style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                    updateInfoPanel(d, root.value);
                }).on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
            
            svg.append("g").selectAll("text").data(root.descendants().slice(1)).join("text")
                .attr("class", "sunburst-text")
                .attr("transform", d => {
                    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                    const y = (d.y0 + d.y1) / 2 * radius;
                    return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
                }).attr("dy", "0.35em").text(d => d.data.name)
                .style("display", d => {
                    const arcAngle = d.x1 - d.x0;
                    const arcRadius = (d.y1 - d.y0) * radius;
                    return (arcAngle < 0.04 || arcRadius < 12) ? "none" : "block";
                });
        }

        function renderTreemap(data, targetContainer, isMainChart) {
            const { width, height } = targetContainer.node().getBoundingClientRect();
            const treemap = d3.treemap().size([width, height]).padding(2);
            const root = treemap(data);
            const svg = targetContainer.append("svg").attr("viewBox", [0, 0, width, height]);

            const leaf = svg.selectAll("g").data(root.leaves()).join("g")
                .attr("transform", d => `translate(${d.x0},${d.y0})`).style("cursor", "pointer")
                .on("click", isMainChart ? (e, p) => renderDrilldownChart(p.parent) : null)
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`<strong>${d.data.name}</strong><br/>Total: $${d.value.toLocaleString()}`).style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                    updateInfoPanel(d, root.value);
                }).on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));

            leaf.append("rect").attr("fill", d => { while (d.depth > 1) d = d.parent; return color(d.data.name); }).attr("fill-opacity", 0.8).attr("width", d => d.x1 - d.x0).attr("height", d => d.y1 - d.y0).attr("class", "treemap-tile");
            leaf.append("text").attr("class", "treemap-label").selectAll("tspan").data(d => d.data.name.split(/(?=[A-Z][^A-Z])/g)).join("tspan").attr("x", 4).attr("y", (d, i) => 13 + i * 10).text(d => d);
        }

        function renderBarChart(data, targetContainer, isMainChart) {
             const { width, height } = targetContainer.node().getBoundingClientRect();
             const margin = {top: 20, right: 30, bottom: 40, left: 120};
             const children = data.children || [];
             const svg = targetContainer.append("svg").attr("width", width).attr("height", height);
             const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
             const y = d3.scaleBand().domain(children.map(d => d.data.name)).range([0, height - margin.top - margin.bottom]).padding(0.2);
             const x = d3.scaleLinear().domain([0, d3.max(children, d => d.value) || 0]).nice().range([0, width - margin.left - margin.right]);
             
             g.selectAll(".bar").data(children).join("rect").attr("class", "bar")
                .attr("fill", d => color(d.data.name)).attr("x", 0).attr("y", d => y(d.data.name))
                .attr("width", d => x(d.value)).attr("height", y.bandwidth())
                .on("click", isMainChart ? (e, p) => renderDrilldownChart(p) : null)
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`<strong>${d.data.name}</strong><br/>Total: $${d.value.toLocaleString()}<br/>${d.children && isMainChart ? 'Click to drill down' : ''}`).style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                    updateInfoPanel(d, data.value);
                }).on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
            
             g.append("g").call(d3.axisLeft(y)).selectAll("text").style("font-size", "10px");
             g.append("g").attr("transform", `translate(0, ${height - margin.top - margin.bottom})`).call(d3.axisBottom(x).ticks(5).tickFormat(d3.format("~s")));
        }

        function renderLineChart(dataNode, targetContainer) {
            const { width, height } = targetContainer.node().getBoundingClientRect();
            const margin = {top: 40, right: 30, bottom: 40, left: 70};
            const svg = targetContainer.append("svg").attr("width", width).attr("height", height).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            const x = d3.scalePoint().domain(["Q1", "Q2", "Q3", "Q4"]).range([0, chartWidth]).padding(0.5);
            const y = d3.scaleLinear().domain([0, d3.max(dataNode.data.values) * 1.2]).nice().range([chartHeight, 0]);

            svg.append("g").attr("class", "grid").call(d3.axisLeft(y).ticks(5).tickSize(-chartWidth).tickFormat(""));
            svg.append("path").datum(dataNode.data.values).attr("class", "line").attr("d", d3.line().x((d, i) => x(["Q1", "Q2", "Q3", "Q4"][i])).y(d => y(d)));
            svg.selectAll(".dot").data(dataNode.data.values).enter().append("circle").attr("r", 4).attr("cx", (d, i) => x(["Q1", "Q2", "Q3", "Q4"][i])).attr("cy", d => y(d)).attr("fill", "#1d4ed8")
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`Value: <strong>$${d.toLocaleString()}</strong>`).style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
                }).on("mouseout", () => { tooltip.transition().duration(500).style("opacity", 0); });
            
            svg.append("g").attr("transform", `translate(0,${chartHeight})`).call(d3.axisBottom(x));
            svg.append("g").call(d3.axisLeft(y).tickFormat(d3.format("$,.0s")));
            svg.append("text").attr("class", "axis-label").attr("text-anchor", "middle").attr("x", chartWidth / 2).attr("y", height - margin.top).text("Quarters");
        }

        // --- UI HELPERS ---
        function updateBreadcrumb(d) {
            if (!d) return;
            const ancestors = d.ancestors().reverse();
            breadcrumbContainer.html(ancestors.map(node => node.data.name).join(" &rarr; "));
        }
        
        function renderLegend(root) {
            legendContainer.html("");
            const topLevel = root.children || [];
            topLevel.forEach(item => {
                const legendItem = legendContainer.append("div").attr("class", "flex items-center");
                legendItem.append("div").style("width", "12px").style("height", "12px").style("background-color", color(item.data.name)).attr("class", "rounded-sm mr-2");
                legendItem.append("span").text(item.data.name);
            });
        }
        
        function updateInfoPanel(d, total) {
            const percentage = ((d.value / total) * 100).toFixed(2);
            infoPanel.html(`<h3 class="font-bold text-gray-900">${d.data.name}</h3><p class="text-gray-600"><strong>Total Cost:</strong> $${d.value.toLocaleString()}</p><p class="text-gray-600"><strong>Share:</strong> ${percentage}% of current view</p><p class="text-gray-600"><strong>Path:</strong> ${d.ancestors().map(d => d.data.name).reverse().join(" / ")}</p>`);
        }

        // --- GEMINI API INTEGRATION ---
        function formatDataForPrompt(node) {
            let output = `${node.data.name} (Total: $${node.value.toLocaleString()})\n`;
            if (node.children) {
                node.children.forEach(child => {
                    output += `  - ${child.data.name}: $${child.value.toLocaleString()}\n`;
                    if (child.children) {
                        child.children.forEach(grandchild => {
                            output += `    - ${grandchild.data.name}: $${grandchild.value.toLocaleString()}\n`;
                        });
                    }
                });
            }
            return output;
        }

        async function getAIInsights() {
            aiInsightsPanel.style("display", "block").html('<div class="flex items-center gap-2 text-blue-800"><div class="spinner"></div><span>Analyzing data...</span></div>');
            
            const systemPrompt = "You are a senior financial analyst. Your task is to provide a brief, insightful summary of the provided cost data. Focus on the most significant cost drivers and any notable distributions. Present your analysis in three concise bullet points using markdown.";
            const userQuery = `Please analyze the following cost data for the fiscal year:\n\n${formatDataForPrompt(currentHierarchyRoot)}`;
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                     // Simple markdown to HTML conversion
                    let htmlContent = text.replace(/^\s*-\s/gm, '<li class="ml-4 list-disc">')
                                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    aiInsightsPanel.html(`<h4 class="font-bold text-blue-900 mb-2">Analysis Complete:</h4><ul>${htmlContent}</ul>`);
                } else {
                    throw new Error("No content received from API.");
                }

            } catch (error) {
                console.error("Gemini API call failed:", error);
                aiInsightsPanel.html(`<div class="text-red-700"><strong>Error:</strong> Failed to generate insights. Please check the console for details.</div>`);
            }
        }

        // --- EVENT LISTENERS ---
        d3.select("#view-toggle").on("change", function() { currentData = this.value === 'org' ? orgData : costData; renderMainChart(); });
        d3.select("#chart-toggle").on("change", function() { currentChartType = this.value; renderMainChart(); });
        backButton.on("click", () => { drilldownContainer.classed("visible", false); });
        d3.select("#ai-insights-button").on("click", getAIInsights);
        window.addEventListener('resize', debounce(renderMainChart, 250));
        renderMainChart();
    </script>
</body>
</html>

